<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TMV Integration</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        font-family: 'Kanit', sans-serif;
        font-weight: 700;
        font-style: normal;
        font-size: large;
        text-shadow: 1px rgb(32, 32, 32);
        color: white;
      }
      body {
        background-color: black;
      }

      .self-progress {
        display: flex;
        width: 300px;
        border-radius: 7px;
        height: 20px;
        box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.2);
        background-color: rgb(234, 234, 234);
        border-radius: 7px;
        margin: 5px;
      }
      .self-progress-value {
        background-color: rgb(33, 33, 134);
        border-radius: 7px;
        transition: width 0.98s;
        background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.15) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.15) 50%,
          rgba(255, 255, 255, 0.15) 75%,
          transparent 75%,
          transparent
        );
        background-size: 20px 20px;
      }
    </style>
  </head>
  <body>
    <div id="root" class="d-none container-fluid"></div>
    <script>
      var hideWindowTimeout = null;

      function applyElement(tag, fn, options) {
        const element = document.createElement(tag);
        fn(element);

        if (options) {
          Object.keys(options).forEach((key) => {
            element.setAttribute(key, options[key]);
          });
        }

        return element;
      }
      function cleanContainer() {
        const root = document.getElementById('root');
        root.innerHTML = '';
        root.classList.add('d-none');
      }
      function renderItem(item) {
        clearInterval(hideWindowTimeout);
        cleanContainer();
        const root = document.getElementById('root');
        root.classList.remove('d-none');

        root.appendChild(
          applyElement(
            'div',
            (el) => {
              el.appendChild(
                applyElement('div', (row) => {}, {
                  id: 'container',
                  style: 'margin-right: 5px; height: 300px; width: 500px;',
                }),
              );

              el.appendChild(
                applyElement(
                  'div',
                  (row) => {
                    row.appendChild(
                      applyElement(
                        'h2',
                        (el) => {
                          el.textContent = 'Чат';
                        },
                        { class: 'text-center' },
                      ),
                    );
                  },
                  { id: 'chat', style: 'height: 300px; width: 300px;' },
                ),
              );
            },
            { class: 'd-flex' },
          ),
        );

        const container = document.getElementById('container');
        container.appendChild(
          applyElement(
            'h2',
            (el) => {
              el.textContent = item.title;
            },
            { class: 'text-center' },
          ),
        );
        if (item.checkType === 'number') {
          container.appendChild(
            applyElement(
              'p',
              (el) => {
                el.textContent = `Напиши в чате число от 1 до ${item.value}`;
              },
              { class: 'text-center' },
            ),
          );
        }

        if (item.checkType === 'cubes') {
          container.appendChild(
            applyElement(
              'p',
              (el) => {
                el.textContent = `Напиши в чате команду !roll (сложность ${item.value.value})`;
              },
              { class: 'text-center' },
            ),
          );
        }

        container.appendChild(
          applyElement('div', (el) => {
            el.style = 'display: flex;';
            el.appendChild(
              applyElement('div', (pb) => {
                pb.id = 'progress-bar';
                pb.classList.add('self-progress');
                pb.appendChild(
                  applyElement('span', (sp) => {
                    sp.id = 'progress-bar-value';
                    sp.style.width = '300px';
                    sp.classList.add('self-progress-value');
                  }),
                );
              }),
            );
            el.appendChild(
              applyElement('span', (sp) => {
                sp.id = 'progress-bar-counter';
                sp.textContent = `${item.delay} сек.`;
              }),
            );
          }),
        );

        if (item.checkType === 'cubes') {
          container.appendChild(
            applyElement('div', (el) => {
              el.style = 'display: flex;';
              el.appendChild(
                applyElement('div', (pb) => {
                  pb.id = 'cubes-progress-bar';
                  pb.classList.add('self-progress');
                  pb.appendChild(
                    applyElement('span', (sp) => {
                      sp.id = 'cubes-progress-bar-value';
                      sp.style.width = '0px';
                      sp.classList.add('self-progress-value');
                    }),
                  );
                }),
              );
              el.appendChild(
                applyElement('span', (sp) => {
                  sp.id = 'cubes-progress-bar-counter';
                  sp.textContent = `0%`;
                }),
              );
            }),
          );
        }
      }

      function calculateWidth(currentValue, maxValue, maxPX) {
        const onePercentPX = maxPX / 100;
        const onePercentValue = maxValue / 100;
        return (currentValue / onePercentValue) * onePercentPX;
      }

      function renderTick(tickData) {
        clearInterval(hideWindowTimeout);
        const pbValue = document.getElementById('progress-bar-value');

        if (pbValue === null) {
          return;
        }

        pbValue.style.width = `${calculateWidth(tickData.delay, tickData.session.delay, 300)}px`;
        document.getElementById('progress-bar-counter').textContent =
          `${tickData.delay} сек.`;

        if (tickData.session.checkType === 'cubes') {
          const cubespbValue = document.getElementById(
            'cubes-progress-bar-value',
          );
          cubespbValue.style.width = `${calculateWidth(tickData.currentPercent, 100, 300)}px`;
          document.getElementById('cubes-progress-bar-counter').textContent =
            `${tickData.currentPercent || 0}%`;
        }
      }

      function twitchMessage(data) {
        const container = document.getElementById('chat');
        container.appendChild(
          applyElement('div', (divEl) => {
            divEl.appendChild(
              applyElement('strong', (el) => {
                el.textContent = data.nickname + ': ';
              }),
            );
            divEl.appendChild(
              applyElement('span', (el) => {
                el.textContent = data.value.toString();
              }),
            );
          }),
        );
        if (container.children.length > 11) {
          container.removeChild(container.children[1]);
        }
      }

      function applyDisappiriens(data) {
        cleanContainer();
        const root = document.getElementById('root');
        root.classList.remove('d-none');

        if (data.session.checkType === 'number') {
          root.appendChild(
            applyElement('h3', (el) => {
              el.classList.add('text-center');
              el.textContent = `К сожалению никто не назвал число ${data.session.currentValue}`;
            }),
          );
        }
        if (data.session.checkType === 'cubes') {
          root.appendChild(
            applyElement('h3', (el) => {
              el.classList.add('text-center');
              el.textContent = `К сожалению вы провалили проверку`;
            }),
          );
          root.appendChild(
            applyElement('h5', (el) => {
              el.classList.add('text-center');
              el.textContent = `Только ${data.winPercent || 0}% из вас бросило больше чем ${data.session.value.value}`;
            }),
          );
        }
        hideWindowTimeout = setTimeout(cleanContainer, 10_000);
      }

      function applyCongratulations(data) {
        cleanContainer();

        const root = document.getElementById('root');
        root.classList.remove('d-none');

        if (data.session.checkType === 'number') {
          root.appendChild(
            applyElement('h3', (el) => {
              el.classList.add('text-center');
              el.textContent = `${data.nickname} назвал число ${data.session.currentValue}`;
            }),
          );
        }
        if (data.session.checkType === 'cubes') {
          root.appendChild(
            applyElement('h3', (el) => {
              el.classList.add('text-center');
              el.textContent = `Поздравляю!`;
            }),
          );
          root.appendChild(
            applyElement('h5', (el) => {
              el.classList.add('text-center');
              el.textContent = `${data.winPercent}% из вас бросило больше чем ${data.session.value.value}`;
            }),
          );
        }

        hideWindowTimeout = setTimeout(cleanContainer, 10_000);
      }

      let connectInterval = null;

      function initConnection() {
        clearInterval(connectInterval);
        const wsConnection = new WebSocket('ws://localhost:3000/ws');
        wsConnection.binaryType = 'arraybuffer';
        wsConnection.onclose = function (event) {
          if (event.wasClean) {
            console.warn('Соединение закрыто чисто');
          } else {
            console.error('Обрыв соединения');
          }
          console.error('Код: ' + event.code + ' причина: ' + event.reason);

          connectInterval = setInterval(initConnection, 1_000);
        };

        wsConnection.onerror = function (error) {
          console.error('Ошибка ' + error.message);
        };

        wsConnection.addEventListener('message', (msg) => {
          const jsonData = JSON.parse(new TextDecoder().decode(msg.data));
          console.log('Received:', jsonData);
          switch (jsonData.event) {
            case 'check:run':
              renderItem(jsonData.data);
              break;
            case 'check:tick':
              renderTick(jsonData.data);
              break;
            case 'check:end':
              cleanContainer();
              break;
            case 'twitch:message':
              twitchMessage(jsonData.data);
              break;
            case 'check:disappiriens':
              applyDisappiriens(jsonData.data);
              break;
            case 'check:congratulations':
              applyCongratulations(jsonData.data);
              break;
            default:
              console.warn('Unknonw ws event', jsonData);
          }
        });
      }
      initConnection();
    </script>
  </body>
</html>
